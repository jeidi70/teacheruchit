<!DOCTYPE html>
<html>
<head>
  <title>Вход | TeacherUchit</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script> 
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script> 
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script> 
  <!-- Конфигурация Firebase -->
  <script src="firebase.js"></script>
  <!-- Стили (пример) -->
  <style>
    body { font-family: Arial; padding: 20px; }
    .hidden { display: none; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>Добро пожаловать в TeacherUchit!</h1>

  <!-- Кнопки входа -->
  <div>
    <button onclick="signInWithGoogle()">Войти через Google</button>
    <button onclick="signInWithPhone()">Войти через телефон</button>
  </div>

  <!-- Форма регистрации/входа -->
  <div style="margin-top: 20px;">
    <input type="email" id="email" placeholder="Email" required />
    <input type="password" id="password" placeholder="Пароль" required />
    <button onclick="signInWithEmail()">Войти</button>
    <button onclick="signUpWithEmail()">Зарегистрироваться</button>
  </div>

  <!-- Выбор роли (скрыто по умолчанию) -->
  <div id="roleSelection" class="hidden">
    <p>Выберите роль:</p>
    <button onclick="setRole('student')">Ученик</button>
    <button onclick="setRole('teacher')">Учитель</button>
  </div>

  <!-- reCAPTCHA для телефона -->
  <div id="recaptcha-container"></div>

  <!-- Логика Firebase -->
  <script>
    // Вход через Google
    function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(() => handleRoleSelection())
        .catch(error => alert(error.message));
    }

    // Вход через телефон
    function signInWithPhone() {
      window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
        'size': 'invisible'
      });
      const phoneNumber = prompt("Введите номер телефона:");
      auth.signInWithPhoneNumber(phoneNumber, window.recaptchaVerifier)
        .then(confirmationResult => {
          const code = prompt("Введите код из SMS:");
          confirmationResult.confirm(code)
            .then(() => handleRoleSelection());
        })
        .catch(error => alert(error.message));
    }

    // Вход по email/паролю
    function signInWithEmail() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(() => handleRoleSelection())
        .catch(error => alert(error.message));
    }

    // Регистрация по email/паролю
    function signUpWithEmail() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.createUserWithEmailAndPassword(email, password)
        .then(() => {
          document.getElementById('roleSelection').classList.remove('hidden');
        })
        .catch(error => alert(error.message));
    }

    // Сохранение роли в Firestore
    function setRole(role) {
      const user = auth.currentUser;
      if (!user) return;
      
      db.collection("users").doc(user.uid).set({ role })
        .then(() => {
          alert(`Роль "${role}" установлена!`);
          window.location.href = "index.html"; // Перенаправление на главную
        })
        .catch(error => alert(error.message));
    }

    // Проверка наличия роли
    function handleRoleSelection() {
      const user = auth.currentUser;
      if (!user) return;

      db.collection("users").doc(user.uid).get()
        .then(doc => {
          if (!doc.exists) {
            document.getElementById('roleSelection').classList.remove('hidden');
          } else {
            window.location.href = "index.html"; // Уже есть роль — перенаправление
          }
        });
    }

    // Прослушиватель состояния аутентификации
    auth.onAuthStateChanged(user => {
      if (user) {
        handleRoleSelection();
      }
    });
  </script>
</body>
</html>