<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Вход - TeacherUchit</title>
  <link rel="stylesheet" href="/assets/modern-design-system.css">
  <link rel="stylesheet" href="/assets/components.css">
  <style>
    body {
      background: linear-gradient(135deg, var(--primary-50) 0%, var(--secondary-50) 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-lg);
    }

    .login-container {
      background: var(--surface-primary);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      padding: var(--spacing-xl);
      width: 100%;
      max-width: 400px;
      border: 1px solid var(--border-primary);
    }

    .login-header {
      text-align: center;
      margin-bottom: var(--spacing-xl);
    }

    .logo {
      width: 64px;
      height: 64px;
      background: var(--primary-500);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto var(--spacing-lg);
      color: white;
    }

    .login-title {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .login-subtitle {
      color: var(--text-secondary);
      font-size: var(--text-base);
    }

    .btn-login {
      width: 100%;
      padding: var(--spacing-lg);
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      margin-top: var(--spacing-lg);
    }

    .register-links {
      text-align: center;
      margin-top: var(--spacing-xl);
      padding-top: var(--spacing-lg);
      border-top: 1px solid var(--border-primary);
    }

    .register-links p {
      margin-bottom: var(--spacing-sm);
      color: var(--text-secondary);
    }

    .register-links a {
      color: var(--primary-500);
      text-decoration: none;
      font-weight: var(--font-medium);
      display: inline-block;
      margin: var(--spacing-xs) var(--spacing-sm);
    }

    .register-links a:hover {
      text-decoration: underline;
    }

    .error-message {
      color: var(--error-500);
      font-size: var(--text-sm);
      margin-top: var(--spacing-xs);
      display: none;
    }

    .form-group.error .form-input {
      border-color: var(--error-500);
    }

    .form-group.error .error-message {
      display: block;
    }

    .success-message {
      background: var(--success-50);
      border: 1px solid var(--success-200);
      color: var(--success-700);
      padding: var(--spacing-sm);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
      font-size: var(--text-sm);
      display: none;
    }

    @media (max-width: 768px) {
      .login-container {
        margin: var(--spacing-md);
        padding: var(--spacing-lg);
      }
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-header">
      <div class="logo">
        <svg class="icon icon-lg">
          <use href="/assets/modern-icons.svg#icon-education"></use>
        </svg>
      </div>
      <h1 class="login-title">Добро пожаловать!</h1>
      <p class="login-subtitle">Войдите в свой аккаунт TeacherUchit</p>
    </div>

    <div id="successMessage" class="success-message">
      Регистрация прошла успешно! Теперь вы можете войти в систему.
    </div>

    <form id="loginForm">
      <div class="form-group">
        <label for="email" class="form-label required">Email</label>
        <input type="email" id="email" name="email" class="form-input" required>
        <div class="error-message">Пожалуйста, введите корректный email</div>
      </div>
      
      <div class="form-group">
        <label for="password" class="form-label required">Пароль</label>
        <input type="password" id="password" name="password" class="form-input" required>
        <div class="error-message">Пожалуйста, введите пароль</div>
      </div>

      <button type="submit" class="btn btn-primary btn-login">
        <svg class="icon icon-sm">
          <use href="/assets/modern-icons.svg#icon-login"></use>
        </svg>
        Войти
      </button>
    </form>

    <div class="register-links">
      <p>Нет аккаунта? Зарегистрируйтесь:</p>
      <a href="/student-registration.html">Как ученик</a>
      <a href="/teacher-registration.html">Как учитель</a>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container"></div>

  <script>
    class Login {
      constructor() {
        this.form = document.getElementById('loginForm');
        this.init();
      }

      init() {
        this.checkRegistrationSuccess();
        this.setupFormValidation();
        this.form.addEventListener('submit', this.handleSubmit.bind(this));
      }

      checkRegistrationSuccess() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('registered')) {
          document.getElementById('successMessage').style.display = 'block';
        }
      }

      setupFormValidation() {
        const inputs = this.form.querySelectorAll('input[required]');
        inputs.forEach(input => {
          input.addEventListener('blur', () => this.validateField(input));
          input.addEventListener('input', () => this.clearFieldError(input));
        });
      }

      validateField(field) {
        const value = field.value.trim();
        let isValid = true;
        let errorMessage = '';

        if (!value) {
          isValid = false;
          errorMessage = 'Это поле обязательно для заполнения';
        } else if (field.type === 'email' && !this.isValidEmail(value)) {
          isValid = false;
          errorMessage = 'Введите корректный email адрес';
        }

        if (!isValid) {
          this.showFieldError(field, errorMessage);
        } else {
          this.clearFieldError(field);
        }

        return isValid;
      }

      showFieldError(field, message) {
        const formGroup = field.closest('.form-group');
        const errorElement = formGroup.querySelector('.error-message');
        
        formGroup.classList.add('error');
        if (errorElement) {
          errorElement.textContent = message;
        }
      }

      clearFieldError(field) {
        const formGroup = field.closest('.form-group');
        formGroup.classList.remove('error');
      }

      isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      async handleSubmit(e) {
        e.preventDefault();
        
        // Валидация всех полей
        const inputs = this.form.querySelectorAll('input[required]');
        let isFormValid = true;
        
        inputs.forEach(input => {
          if (!this.validateField(input)) {
            isFormValid = false;
          }
        });

        if (!isFormValid) {
          this.showToast('Пожалуйста, исправьте ошибки в форме', 'error');
          return;
        }

        const formData = new FormData(this.form);
        const email = formData.get('email');
        const password = formData.get('password');

        try {
          // Поиск пользователя в localStorage
          const users = JSON.parse(localStorage.getItem('users') || '[]');
          const user = users.find(u => u.email === email && u.password === password);

          if (!user) {
            this.showToast('Неверный email или пароль', 'error');
            this.showFieldError(document.getElementById('email'), 'Проверьте правильность данных');
            this.showFieldError(document.getElementById('password'), 'Проверьте правильность данных');
            return;
          }

          // Сохранение текущего пользователя
          localStorage.setItem('currentUser', JSON.stringify(user));
          localStorage.setItem('user', JSON.stringify(user)); // Для совместимости

          this.showToast('Вход выполнен успешно!', 'success');

          // Перенаправление в зависимости от роли
          setTimeout(() => {
            if (user.role === 'teacher') {
              window.location.href = '/teacher-dashboard.html';
            } else {
              window.location.href = '/student-dashboard.html';
            }
          }, 1500);

        } catch (error) {
          console.error('Ошибка входа:', error);
          this.showToast('Произошла ошибка при входе. Попробуйте еще раз.', 'error');
        }
      }

      showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type} show`;
        
        const iconMap = {
          success: 'icon-success',
          error: 'icon-error',
          warning: 'icon-warning',
          info: 'icon-info'
        };

        toast.innerHTML = `
          <svg class="toast-icon icon icon-sm">
            <use href="/assets/modern-icons.svg#${iconMap[type]}"></use>
          </svg>
          <div class="toast-content">
            <div class="toast-message">${message}</div>
          </div>
          <button class="toast-close" onclick="this.parentElement.remove()">
            <svg class="icon icon-sm">
              <use href="/assets/modern-icons.svg#icon-close"></use>
            </svg>
          </button>
        `;

        let container = document.querySelector('.toast-container');
        if (!container) {
          container = document.createElement('div');
          container.className = 'toast-container';
          document.body.appendChild(container);
        }

        container.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
      }
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', () => {
      new Login();
    });
  </script>
</body>
</html>